#!/usr/bin/env bash

set -eo pipefail
shopt -s inherit_errexit

changed() {
  git add "${1}"
  git commit --quiet -a -m "${script} ${1}"
}

doctor() {
    asciidoctor -b manpage \
    -a doctitle="${name^^}(1)" \
    -a author="${author}" \
    -a release-version="${version:-0.0.0}" \
    -a manmanual="${name^} Manual" \
    -a mansource="${name^} ${version:-0.0.0}" \
    -a name="${name}" \
    -o "${1}" "${file}"
}

main() {
  local arg tmp_file dest_dir dest_file dir src tmp_file
  for arg do
    case "${arg}" in
      -h|--help) man -p cat "${0##*/}" 2>/dev/null || exit 1 ;;
      *) dir="${arg}"; break ;;
    esac
  done


  cd "${dir:-.}" || die Directory not found: "$(1:-.)"
  cd "$(git top)" || die Invalid Git Dir: "$(pwd)"
  author="$(git config user.username)"
  version=$(git latest)
  script=${0##*/}

  while read -r file; do
    src="${file%.*}"
    name="${src##*/}"
    dest_dir="$(dirname "$(dirname "$(dirname "${src}")")")/share/man/man1"
    dest_file="${dest_dir}/${name}.1"
    [ -d "${dest}" ] || { mkdir -p "${dest_dir}"; touch "${dest_dir}/.gitkeep"; changed "${dest_dir}/.gitkeep"; }
    if [ -f "${dest_file}" ]; then
      tmp_file="/tmp/${name}.1"
      doctor "${tmp_file}"
      if ! cmp -s "${dest_file}" "${tmp_file}"; then
        mv "${tmp_file}" "${dest_file}"
        changed "${dest_file}"
      fi
    else
      doctor "${dest_file}"
      changed "${dest_file}"
    fi
  done < <(find . -type f -name "*.adoc")
}

main "${@}"
