#!/bin/sh

# Creates system profile generated files.
#
cd "$(dirname "$(dirname "$0")")" || exit 1; . helpers.lib

set -x
set -o verbose
_input() {
  . "input/${function}"
  file="${RC_GENERATED}/${function}.sh"
}


#######################################
# RC env: directories and files
#
env() {
  function='env'
  _input
  _generated "${env}"
  unset env function
}

#######################################
# Base init PATH, INFOPATH or MANPATH
# Globals:
#   EXPORT              Variable name to add export command.
# Arguments:
#   value               Path value to show or add export command.
# Output:
#   value or variable and value with export command.
#######################################
path() {
  function='path'
  _input

  for i in infopath manpath path; do
    unset value
    tmp="$(mktemp)"
    eval echo \""\$${i}"\" | grep "${UNAME}" | tail -r > "${tmp}" || die
    while read -r line; do
      [ "$(echo "${line}" | awk -F ';' '{ print NF-1 }')" -eq "$(( fields-1 ))" ] || die Incorrect Fields: "${line}"
      # Todo: me duermo
      value="$(colon "${line%";${UNAME}"}" "${value:-}")"
    done < "${tmp}"
    append=''; [ "${i}" = 'path' ] || append='-a'
    variable="$(echo "${i}" | tr '[:lower:]' '[:upper:]')"
    _generated "$(colon "${value}" --export="${variable}")" ", variable: ${variable}"
  done
  unset append i infopath line manpath path tmp value
}

main() {
  if test "$#" -eq 0 || { test "${1-}" = '--parsed' && shift; }; then
    for func in env path; do ${func}; done
  else
    PARSE="${0}" parse "$@"
  fi
}

main "$@"
