#!/bin/sh

# Absolute logical (symlink, default) or resolved (physical, pwd -P) path (Accepts one level up if it doesn't exist).
#
STRICT=1 . helpers.lib

#######################################
# Absolute logical (symlink, default) or resolved (physical, pwd -P) path (Accepts one level up if it doesn't exists)
# Arguments:
#   --dirname       Show dirname instead of path (default: unset)
#   --fail          Exit if path does not exists (default: unset)
#   --resolved      Resolve symlinks (pwd -P).
#   path            Path (default: cwd).
# Output:
#   Path or help message to stdout.
# Returns:
#   1 if parent directory does not exist.
# Examples:
#   $ real --resolved /tmp/file  # one level up: accepts, if not file/dir.
#   /private/tmp/file
#   $ real --resolved --fail /tmp/file    # one level up: does not accept, if not file/dir.
#   Directory not Found: /tmp/file
#   $ real --dirname --resolved /tmp/file  # one level up: accepts, if not file/dir.
#   /private/tmp
#   $ real --resolved --fail --quiet /tmp/file
#   Directory not Found: /tmp/file
#   $ real --resolved /tmp/file1/file2
#   Directory not Found: /tmp/file1
#   $ cd /tmp; rm -rf d1 d2 d3; mkdir d1; ln -s d1 d2; ln -s d2 d3; touch d1/f1;ln -s d1/f1 d1/f2;real --resolved d3/f2
#   /private/tmp/d1/f1
#   $ cd /tmp; rm -rf d1 d2; mkdir d1; ln -s d1 d2; touch d1/f1;ln -s d1/f1 d1/f2;real --resolved d2/f2
#   /private/tmp/d1/f1
#   $ cd /tmp; rm -rf d1 d2; mkdir d1; ln -s d1 d2; touch d1/f1;ln -s d1/f1 d1/f2;real --resolved d2/f1
#   /private/tmp/d1/f1
#   $ cd /tmp; rm -rf d1 d2; mkdir d1; ln -s d1 d2; touch d1/f1;ln -s d1/f1 d1/f2;real --resolved d1/f2
#   /private/tmp/dir1/file1
#######################################
if [ ! "${1-}" ] || [ "${PARSED-}" ]; then
  unset PARSED
  for arg do
    shift
    case "${arg}" in
      --dirname) dir=1 ;;
      --fail) fail=1 ;;
      --resolved) resolved=1 ;;
    esac
  done

  arg="${1:-.}"

  if [ -d "${arg}" ]; then
    cd "${arg}" 2>/dev/null || die Directory not Found: "${arg}"
  elif [ -L "${arg}" ] && test "${resolved-}"; then
    while [ -L "${arg}" ]; do
      arg="$(readlink "${arg}")"
    done
    dirname="$(dirname "${arg}")"
    cd "${dirname}" 2>/dev/null || die Directory not Found: "${dirname}"
    basename="$(basename "${arg}")"
  elif [ -f "${arg}" ]; then
    dirname="$(dirname "${arg}")"
    cd "${dirname}" 2>/dev/null || die Directory not Found: "${dirname}"
    basename="$(basename "${arg}")"
  else
    ! test "${fail-}" || die Directory or File not Found: "${arg}"
    dirname="$(dirname "${arg}")"
    cd "${dirname}" 2>/dev/null || die Directory not Found: "${dirname}"
    basename="$(basename "${arg}")"
  fi

  if test "${resolved-}"; then
    dirname="$(pwd -P)";
  else
    dirname="$(pwd)"
  fi

  if test "${basename-}" && test -z "${dir-}"; then
    echo "${dirname}/${basename}"; exit
  fi
  echo "${dirname}"
else
  PARSE="${0}" parse "$@"
fi
