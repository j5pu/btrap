#!/usr/bin/env bash

# rc.d docker images, build, etc.
#
STRICT=1 . helpers.lib

. colorf.lib

# TODO: que el docker mio haga el env cuando hay run y exec, etc. y pille los secretos.... no funcionaria si es swarm?
#   o no host ?
#######################################
# EXCLUDE           Excluded IDs when doing 'docker run' for all (not shell CMD/ENTRYPOINT if 'ENTRY' unset).
EXCLUDE="^bats|^python"
#######################################
# FIELDS            Fields in 'IMAGES' global.
FIELDS="8"
#######################################
# IMAGES            enable;<repo owner>;<repo name>;<tag>;stripname;striptag;sh;bash
IMAGES=$(cat <<EOF
1;alpine;;;;;sh;
1;archlinux;;;;;bash;1
1;bash;;;;;sh;1
0;bash;;5.1;;;sh;1
0;bash;;5.0;;;sh;1
0;bash;;4.4;;;sh;1
1;bats;bats;;;;sh;1
1;busybox;;;;;sh;
1;centos;;;;;bash;1
1;debian;;;;;dash;1
1;debian;;bullseye-backports;;bullseye-;dash;1
1;debian;;bullseye-slim;;bullseye-;dash;1
1;fedora;;;;;bash;1
0;jrei;systemd-ubuntu;;;;dash;1
1;kalilinux;kali-rolling;;-rolling;;dash;1
1;kalilinux;kali-bleeding-edge;;-bleeding;;dash;1
1;nixos;nix;;;;busybox;
0;python;;3.9-alpine;;-alpine;sh;
0;python;;3.9-bullseye;;;dash;1
0;python;;3.9-slim;;;dash;1
1;python;;3.10-alpine;;-alpine;sh;
1;python;;3.10-bullseye;;;dash;1
1;python;;3.10-slim;;;dash;1
1;ubuntu;;;;;dash;1
1;zshusers;zsh;;;;dash;
EOF
)

#######################################
# Docker hub build hook
# https://docs.docker.com/docker-hub/builds/advanced/
# https://dev.to/samuelea/automate-your-builds-on-docker-hub-by-writing-a-build-hook-script-13fp
# https://codeclimbing.com/automate-your-builds-on-docker-hub-by-writing-a-build-hook-script/
# on macOS builds for linux/amd64 (OS, ARCH). Igual hay ue compilar para ms pero el mac no puede
# Globals (Docker Hub):
#   COMMIT_MSG         Message from the commit being tested and built.
#   DOCKER_REPO        Name of the Docker repository being built (index.docker.io/<repo owner>/<repo name>)
#   DOCKER_TAG         Docker repository tag being built.
#   DOCKERFILE_PATH    Dockerfile currently being built.
#   IMAGE_NAME         Name and tag of the Docker repository being built.
#                      This variable is a combination of DOCKER_REPO:DOCKER_TAG.
#   SOURCE_BRANCH      Name of the branch or the tag that is currently being tested.
#   SOURCE_COMMIT      SHA1 hash of the commit being tested.
# Globals:
#   BASE               The base images (never get pushed).
#   HUB                Running in auto build Docker Hub.
#   ID                 The ID to build, create, exec or run command (default: all).
#   OUTPUT             Show output in plain format even if succesful build.
#   PUSH               Perform push after build.
#   SHOW               Show image id for exec and run.
#   TARGET             --target option.
#   TARGETS            Targets from Dockerfile.
#######################################
# shellcheck disable=SC2086
rcdocker::build() {
  local base=$BASE image output output_text param="${1:-${ID}}" target="${TARGET:+--target ${TARGET}}"
  local id build container repo tag sh

  if $HUB; then
    if command -v curl; then
      curl --help || true
    fi
    if command -v wget; then
      wget --help || true
    fi
    echo "\$0: ${0}"
    echo "dirname \$0: $(dirname "${0}")"
    echo "ls dirname: $(ls -la "$(dirname "${0}")")"
    echo "ls dirname dirname: $(ls -la "$(dirname "$(dirname "${0}")")")"
    echo "pwd: $(pwd)"
    echo "uname: $(uname)"
    if test -f /etc/os-release; then command cat /etc/os-release; fi
    echo "DOCKERFILE_PATH: ${DOCKERFILE_PATH}"
    if command -v git; then
      echo "top: $(git rev-parse --show-toplevel)"
      echo "ls top: $(ls -la "$(git rev-parse --show-toplevel)")"
    fi
    if command -v tar; then
      tar --help
    fi
    exit
  fi

  [ ! "${TARGETS-}" ] || die Build Targets not Implemented  # if TARGETS create all targets?
  while read -r id build container repo tag sh; do
    if [ "${param-}" ] && [ "${param}" != "${id}" ]; then continue; fi
    BASE=true && rcdocker::pull "${id}" && BASE=$base
    output="$(rcdocker::tmp "${id}")"
    if docker build --progress plain ${CACHE} ${target} \
      --build-arg repo="${repo}" --build-arg tag="${tag}" \
      --file "${DOCKERFILE_PATH}" --tag "${build}" . &>"${output}"; then
      image="${repo}:${tag}"
      output_text="$(cat "${output}")"
      grep -q -E "FROM.*/${image}" "${output}" || die Invalid FROM image in Dockerfile: "${output_text}"
      if $SHOW || [[ "${FUNCNAME[1]}" =~ rcdocker::create::force|rcdocker::main ]] ; then
        if $TEST; then
          success "${build}"
        else
          success Built: "${build}", from: "${image}"
          if ! $HUB && $SCAN; then rcdocker::scan "${build}"; fi
        fi
      fi
      if $OUTPUT; then success Build Output: "${build}" "$(cat "${output}")"; fi
      rcdocker::push "${id}" "${build}"
    else
      output_text="$(cat "${output}")"
      die Build Error: "${build}" "${output_text}"
    fi
  done < <(rcdocker::vars "")
}

#######################################
# description
# Globals:
#   FORCE
#   FUNCNAME
#   ID
#   SHOW
#   TEST
#   WARN
# Arguments:
#   1
#   2
#   3
#######################################
rcdocker::build::test::quiet::die() {
  local container containers exists=false i output output_text running=false
  if $TEST; then
    ID="${1}"
    output="$(rcdocker::tmp "${1}")"
    containers="$(docker ps -a -q  --filter="ancestor=${2}")"  # Gives all containers regardless of the tag.
    for i in ${containers}; do
      if [ "$(docker inspect "${i}" --format "{{.Config.Image}}")" = "${2}" ]; then
        exists=true
        container="$(docker ps -q -f status=running -f name="${3}")"
        if [ "${container-}" ]; then running=true; fi
        if $exists  && docker rm --force "${i}" &>"${output}"; then
          if $SHOW && [[ ! "${FUNCNAME[1]}" =~ rcdocker::run ]]; then
            if $WARN; then warn Removed Container: "${i}", exists: "${exists}", running: "${running}", \
FORCE: "${FORCE}", TEST: "${TEST}"; fi
          fi
        else
          output_text="$(cat "${output}")"
          die Remove Container: "${i}" "${output_text}"
        fi
      fi
    done
    exists=false
    if docker inspect "${2}" &>"${output}"; then
      exists=true
    fi
    if $exists; then
      if docker rmi --force "${2}" &>"${output}"; then
        if $SHOW && [[ ! "${FUNCNAME[1]}" =~ rcdocker::run|rcdocker::exec::rm ]]; then
          if $WARN; then warn Removed Image: "${2}", exists: "${exists}", FORCE: "${FORCE}", TEST: "${TEST}"; fi
        fi
      else
        output_text="$(cat "${output}")"
        die Remove Image: "${2}" "${output_text}"
      fi
    fi
    rcdocker::build "${1}"
  elif $SHOW; then
    success "${2}"
  fi
}

#######################################
# description
# Arguments:
#  None
#######################################
rcdocker::clean() {
  local i
  docker container prune --force &>/dev/null
  # shellcheck disable=SC2046
  for i in $(docker ps -q -f status=paused); do
    docker container unpause "${i}" &>/dev/null && docker stop "${i}" &>/dev/null
  done
  for i in $(comm -23 <(docker ps -aq | sort) <(docker ps -q -f status=running | sort)); do \
    docker rm --volumes "${i}"; done
  docker image prune --all --force &>/dev/null
  docker volume prune --force &>/dev/null
  docker network prune --force &>/dev/null
  docker system prune --all --volumes --force &>/dev/null
  docker builder prune --all --force &>/dev/null
  docker system df
}

#######################################
# Create a container with default name if it does not exist.
# Globals:
#   ID                The ID to build, create, exec or run command (default: all).
#######################################
rcdocker::create() {
  local image
  local id build container repo tag
  if [ "${ID-}" ]; then
    image="$(rcdocker::image "${ID}")"
    container="$(rcdocker::vars | grep "^${ID} " | awk '{ print $3 }')"
    rcdocker::create::force "${ID}" "${image}" "${container}"
  else
    while read -r id build container repo tag; do
      rcdocker::create::force "${id}" "${build}" "${container}"
    done < <(rcdocker::vars)
  fi
}

#######################################
# description
# Globals:
#   BASE
#   FORCE
#   PUSH
#   START
#   TEST
#   WARN
# Arguments:
#   1
#   2
#   3
# Returns:
#   <unknown> ...
#######################################
rcdocker::create::force() {
  local container create=true exists=false output output_text running=false
  rcdocker::build::test::quiet::die "${1}" "${2}"
  if docker container inspect "${3}" &>/dev/null; then
    exists=true
    container="$(docker ps -q -f status=running -f name="${3}")"
    if [ "${container-}" ] && running=true && ! $TEST && ! $FORCE; then create=false; fi
  fi
  if $create; then
    if { $exists || $running; } && docker rm --force "${3}" &>/dev/null; then
      if $WARN; then warn Removed: "${3}", exists: "${exists}", running: "${running}", FORCE: "${FORCE}", \
TEST: "${TEST}"; fi
    fi
    output="$(rcdocker::tmp "${1}")"
    if docker create -it --name "${3}" "${2}" &>"${output}"; then
      success Created: "${3}"
      if $START; then
        if docker start "${3}" >/dev/null; then
          success Started: "${3}"
        else
          false || die Start: "${3}"
        fi
      fi
      return
    fi
    if ! docker manifest inspect "${2}" &>"${output}"; then
      if grep -q "^no such manifest:" "${output}"; then
        if $WARN; then No Manifest: "${2}"; fi
        { $BASE || $TEST; } || PUSH=true
        rcdocker::build "$(rcdocker::id "${2}")"
      elif grep -q "^unauthorized: authentication required" "${output}"; then
        false || die Authentication Required: "${2}"
      elif grep -q "^unsupported manifest media type and no default available" "${output}"; then
        if $WARN; then warn Manifest Unsupported: "${2}"; fi
        { $BASE || $TEST; } || PUSH=true
        rcdocker::build "$(rcdocker::id "${2}")"
      elif [ -n "$(command cat "${output}")" ]; then
        output_text="$(cat "${output}")"
        false || die Manifest Error: "${2}" "${output_text}"
      fi
    fi
    if docker create -it --name "${3}" "${2}" &>"${output}"; then
      success Created: "${3}"
      if $START; then
        if docker start "${3}" >/dev/null; then
          success Started: "${3}"
        else
          false || die Start: "${3}"
        fi
      fi
    else
      output_text="$(cat "${output}")"
      die Create Error: "${3}" "${output_text}"
    fi
  fi
}

#######################################
# description
# Globals:
#   ENTRY
# Arguments:
#  None
#######################################
rcdocker::entry() { echo "${ENTRY:+--entrypoint ${ENTRY}}"; }

#######################################
# Exec command in an ephemeral container.
# Globals:
#   ID                The ID to build, create, exec or run command (default: all).
#   SHOW              Show image id for exec and run.
#   TEST              Build local images if repository is not base.
#######################################
rcdocker::exec() {
  local i image
  export ARGUMENTS=("$@")
  if [ "${ID-}" ]; then
    image="$(rcdocker::image "${ID}")"
    rcdocker::exec::rm "${ID}" "${image}"
  else
    for i in $(rcdocker::id); do
      image="$(rcdocker::image "${i}")"
      rcdocker::exec::rm "${i}" "${image}"
    done
  fi
}

# shellcheck disable=SC2046
rcdocker::exec::rm() {
  local name="exec-${1}" output
  output="$(rcdocker::tmp "${name}")"
  docker rm --force "${name}" &>/dev/null || true
  if ! $TEST; then
    if ! docker inspect "${2}" &>"${output}"; then
      rcdocker::build "${1}"
    fi
  fi
  rcdocker::build::test::quiet::die "${1}" "${2}"
  docker rm --force "${name}" &>/dev/null || true
  if docker run -dit $(rcdocker::entry) --name "${name}" "${2}" >/dev/null; then
    set +e
    docker exec -it "${name}" "${ARGUMENTS[@]}"
    set -e
    docker rm --force "${name}" &>/dev/null || true
  fi
}

#######################################
# Shows ids or image/container
# Globals:
#   IMAGE              IMAGE (default: all).
# Arguments:
#   image              IMAGE (default: all).
#######################################
rcdocker::id() {
  local ids images param sh vars
  param="${1:-${IMAGE:-}}"
  vars="$(rcdocker::vars)"
  ids="$(echo "${vars}" | awk '{ print $1 }')"
  sh="$(echo "${vars}" | awk '{ print $7 }')"
  images="$(echo "${vars}" | awk '{ print $2 }')"
  if [ "${param-}" ]; then
    echo "${images}" | grep -q "^${param}$" || die Invalid Image: "${param}"
    echo "${vars}" | grep " ${param} " | awk '{ print $1 }'
  elif [ "${SH-}" ]; then
    echo "${vars}" | grep -q " ${SH}$" || die Invalid ID: "${SH}"
    echo "${vars}" | awk "/ ${SH}$/ { print \$2 }"
  else
    echo "${ids}"
  fi
}

#######################################
# Shows image for id.
# Globals:
#   ID                The ID to build, create, exec or run command (default: all).
# Arguments:
#   id                ID to build, create, exec or run command (default: all).
# ######################################
rcdocker::image() {
  local ids images param vars
  param="${1:-${ID:-}}"
  vars="$(rcdocker::vars)"
  ids="$(echo "${vars}" | awk '{ print $1 }')"
  images="$(echo "${vars}" | awk '{ print $2 }')"
  if [ "${param-}" ]; then
    echo "${ids}" | grep -q "^${param}$" || die Invalid ID: "${param}"
    echo "${vars}" | awk "/^${param} / { print \$2 }"
  elif [ "${SH-}" ]; then
    echo "${vars}" | grep -q " ${SH}$" || die Invalid ID: "${SH}"
    echo "${vars}" | awk "/ ${SH}$/ { print \$2 }"
  else
    echo "${images}"
  fi
}

#######################################
# Pull for base images.
# Globals:
#   ID                ID to pull (default: all).
# Arguments:
#   id                ID to pull (default: all).
#######################################
rcdocker::pull() {
  local param="${1:-${ID}}"
  local id build container repo tag sh
  if [ "${param-}" ]; then
    rcdocker::pull::id "${param}" "$(rcdocker::image "${param}")"
  else
    while read -r id build container repo tag sh; do
      if [ "${param-}" ] && [ "${param}" != "${id}" ]; then continue; fi
      rcdocker::pull::id "${param}" "${build}"
    done < <(rcdocker::vars)
  fi
}

#######################################
# description
# Globals:
#   FUNCNAME
#   OUTPUT
#   SHOW
# Arguments:
#   1
#   2
#######################################
rcdocker::pull::id() {
  local output output_text
  output="$(rcdocker::tmp "${1}")"
  if docker pull "${2}" &>"${output}"; then
    if $SHOW || [ "${FUNCNAME[1]}" = "rcdocker::main" ]; then
      if ! grep -q "Status: Image is up-to-date for ${2}" "${output}"; then
        success Pulled: "${2}"
      fi
    fi
    if $OUTPUT; then grey Pull output: "${2}" "$(cat "${output}")"; fi
  else
    output_text="$(cat "${output}")"
    die Pull Error: "${2}" "${output_text}"
  fi
}

#######################################
# push
# Globals:
#   BASE              Base images (never get pushed).
#   HUB               Running in auto build Docker Hub.
#   PUSH              Perform push after build.
#   OUTPUT            show output in plain format even if succesful build.
#   SHOW              Show image id for exec and run.
# Arguments:
#   id
#   image
#######################################
rcdocker::push() {
  local output output_text
  output="$(rcdocker::tmp "${1}")"
  if ! $BASE; then
    if $HUB || $PUSH; then
      if docker push "${2}" &>"${output}"; then
        if $SHOW || [[ "${FUNCNAME[1]}" =~ rcdocker::build|rcdocker::main ]] ; then success Pushed: "${2}" ; fi
        if $OUTPUT; then success Push output: "${2}" "$(cat "${output}")"; fi
      else
        output_text="$(cat "${output}")"
        die Push Error: "${2}" "${output_text}"
      fi
    fi
  fi
}

#######################################
# Runs command in an ephemeral container.
# Globals:
#   EXCLUDE           IDs to be excluded IDs when doing 'docker run' for all (not shell CMD/ENTRYPOINT if 'ENTRY' unset).
#   ID                ID to build, create, exec or run command (default: all).
#   SHOW              Show image id for exec and run.
#   TEST              Build local images if repository is not base.
#######################################
# shellcheck disable=SC2046
rcdocker::run() {
  local i image output
  if [ "${ID-}" ]; then
    image="$(rcdocker::image "${ID}")"
    output="$(rcdocker::tmp "${ID}")"
    if ! docker inspect "${image}" &>"${output}" && ! $TEST; then
      rcdocker::build "${ID}"
    fi
    rcdocker::build::test::quiet::die "${ID}" "${image}"
    set +eo pipefail
    docker run -it $(rcdocker::entry) --rm "${image}" "$@" | grep -v "failed to resize tty"
    set -eo pipefail
    if $TEST; then docker rmi "${image}" >/dev/null; fi
  else
    for i in $(rcdocker::id); do
      if [[ "${i}" =~ ${EXCLUDE} ]] && [ ! "${ENTRY-}" ]; then continue; fi
      output="$(rcdocker::tmp "${i}")"
      image="$(rcdocker::image "${i}")"
      if ! docker inspect "${image}" &>"${output}" && ! $TEST; then
        rcdocker::build "${i}"
      fi
      rcdocker::build::test::quiet::die "${i}" "${image}"
      set +eo pipefail
      docker run -it $(rcdocker::entry) --rm "${image}" "$@" | grep -v "failed to resize tty"
      set -eo pipefail
      $TEST && docker rmi "${image}" >/dev/null
    done
  fi
}

#######################################
# description
# Globals:
#   DOCKERFILE_PATH
# Arguments:
#   1
#######################################
rcdocker::scan() {
  docker scan --accept-license --exclude-base --file "${DOCKERFILE_PATH}" "${1}"
}

#######################################
# description
# Globals:
#   FUNC
#   FUNCNAME
#   ID
# Arguments:
#   1
#######################################
rcdocker::tmp() { local tmp="/tmp/${FUNC}"; mkdir -p "${tmp}" && echo "${tmp}/${1:-${ID}}-${FUNCNAME[1]##*:}.out"; }

#######################################
# description
# Arguments:
#  None
#######################################
rcdocker::usage() {
    echo -e "
$(yellow usage):
  $(green rcdocker) [command] [options] [-- args]

$(green Description):
  $(blue Output) is $(red not shown) for $(green create), $(green exec) and \
$(green run) unless: $(magenta --show) or $(magenta --output).
  $(blue Development tests) (a new build/no push is run each time the script is called) can be run with: \
$(magenta --test), and check the output or error code.
  $(blue Portability tests) can be 'run' for all images using: $(magenta --show), to see which \
image is producing the output.

$(green Commands):
  $(green build)                 Build (will be changed to pull when --base).
  $(green clean)                 Prune.
  $(green create)                Create containers.
  $(green exec)                  Exec command in an ephemeral containers for all (rc, --base or test-rc) \
or --id container.
  $(green id)                    Show IDs for all or for image/container.
  $(green image)                 Show images for repository, --base or repository --test.
  $(green pull)                  Pull base images for --base.
  $(green run)                   Run command in an ephemeral containers for all (rc, --base or test-rc \
excluding containers with no shell ENTRYPOINT/CMD, i.e: bats, python) or --id container.
  $(green vars)                  Show vars for rc, --base or test-rc (--test).

$(green Options):
  $(magenta --base)                Use base containers.
  $(magenta --dry-run)             Dry-run.
  $(magenta --entry=entrypoint)    Overwrite default rc ENTRYPOINT (/bin/sh), \
--entry="" to restore Dockerfile ENTRYPOINT.
  $(magenta --force)               Force new build and re-creation of container (remove existing containers), \
default true for --test.
  $(magenta --id='<id>')           ID for all or image.
  $(magenta --image='<image>')     Image for getting ID.
  $(magenta --no-cache)            Build with no cache.
  $(magenta --output)              Shows the output of the container after it has been build \
(docker build --output=plain) or output of silent commands (docker pull, etc.).
  $(magenta --push)                Push image after build (only for rc)
  $(magenta --repo='<repo>')       Repository to customize vars.
  $(magenta --start)               Start after create.
  $(magenta --sh='bash|dash|sh')   Show images or ids where /bin/sh is bash.
  $(magenta --show)                Prepend a line with the image name for exec and run (helpful for portability \
tests to see which image produced the output).
  $(magenta --test)                Use a local test image for rc.
  $(magenta --)                    Separator for exec or run command to provide docker exec/run command and \
arguments.
  $(magenta args)                  Exec/run command and arguments to pass to docker exec/run.

$(green Errors):
  $(success rcdocker "$(green build)" -python3.99)
  $(success rcdocker "$(green build)" python3.99)
  $(success rcdocker "$(green build)" --id=python3.99)
  $(success rcdocker "$(green build)" --target=foo)
  $(success rcdocker "$(green build)" "$(green run)")
  $(success rcdocker "$(green exec)" --id=python3.10 ls)
  $(success rcdocker "$(green exec)")
  $(success rcdocker "$(green exec)" --)
  $(success rcdocker "$(green id)" --image=foo)
  $(success rcdocker "$(green image)" --id=foo)
  $(success rcdocker "$(green run)" --dry-run)
  $(success rcdocker "$(green run)" --dry-run --)

$(green Examples):
  $(grey [Docker Hub]: build and push, [Local]: help)
  $(success rcdocker)

  $(grey Build ID)
  $(success rcdocker "$(green build)" --id="alpine")
  $(grey Build python3.9 with new test build and show build output)
  $(success rcdocker "$(green build)" --id="python3.10" --no-cache --output --test)
  $(grey Pull base images)
  $(success rcdocker "$(green build)" --pull)
  $(grey Pull base ID image)
  $(success rcdocker "$(green build)" --pull --id="alpine")
  $(grey Build ID and push)
  $(success rcdocker "$(green build)" --id="alpine" --push)
  $(grey Build ID with test)
  $(success rcdocker "$(green build)" --id="alpine" --test)
  $(grey Build all)
  $(success rcdocker "$(green build)")
  $(grey Build and Push all)
  $(success rcdocker "$(green build)" --push)
  $(grey Build all test)
  $(success rcdocker "$(green build)" --test)

  $(grey Clean removes all but running containers)
  $(success rcdocker "$(green clean)")

  $(grey Create)
  $(success rcdocker "$(green create)")
  $(grey Create and force removing running containers)
  $(success rcdocker "$(green create)" --force)
  $(grey Create with new test build)
  $(success rcdocker "$(green create)" --test)
  $(grey Create alpine container)
  $(success rcdocker "$(green create)" --id="alpine")
  $(grey Create alpine container and force removing running existing container)
  $(success rcdocker "$(green create)" --id="alpine" --force)
  $(grey Create alpine container with new test build)
  $(success rcdocker "$(green create)" --id="alpine" --test)
  $(grey Create alpine container with new test build and start)
  $(success rcdocker "$(green create)" --id="alpine" --test --start)
  $(grey Create for base)
  $(success rcdocker "$(green create)" --base)
  $(grey Create and start for base)
  $(success rcdocker "$(green create)" --base --start)
  $(grey Create and force removing running containers for base)
  $(success rcdocker "$(green create)" --base --force)
  $(grey Create alpine container for base)
  $(success rcdocker "$(green create)" --base --id="alpine")
  $(grey Create alpine container and force removing running existing container for base)
  $(success rcdocker "$(green create)" --base --id="alpine" --force)

  $(grey Dry run)
  $(success rcdocker "$(green --dry-run)" -- ls)

  $(grey Exec command for rc)
  $(success rcdocker "$(green exec)" -- whoami)
  $(grey Exec command with new test build for rc)
  $(success rcdocker "$(green exec)" --test -- whoami)
  $(grey Exec command and add image name to output for rc repository)
  $(success rcdocker "$(green exec)" --show -- whoami)
  $(grey Exec command with new test build and add image name to output for rc)
  $(success rcdocker "$(green exec)" --show --test -- whoami)
  $(grey Exec command override ENTRYPOINT)
  $(success rcdocker "$(green exec)" --entry="" --id="bash" -- whoami)
  $(grey Exec command for rc)
  $(success rcdocker "$(green exec)" --id=alpine -- whoami)
  $(grey Exec command with new test build and add image name to output  for rc)
  $(success rcdocker "$(green exec)" --test --id=alpine -- whoami)
  $(grey Exec command and add image name to output  for rc)
  $(success rcdocker "$(green exec)" --show --id=alpine -- whoami)
  $(grey Exec command with new test build and add image name to output  for rc)
  $(success rcdocker "$(green exec)" --show --test --id=alpine -- whoami)
  $(grey Exec command for base)
  $(success rcdocker "$(green exec)" --base -- whoami)
  $(grey Exec command and add image name to output for base)
  $(success rcdocker "$(green exec)" --base --show -- whoami)
  $(grey Exec command for base)
  $(success rcdocker "$(green exec)" --base --id="alpine" -- whoami)
  $(grey Exec command and add image name to output  for base)
  $(success rcdocker "$(green exec)" --base --show --id="alpine" -- whoami)

  $(grey IDs)
  $(success rcdocker "$(green id)")
  $(grey IDs which /bin/sh is sh)
  $(success rcdocker "$(green id)" --sh)
  $(grey IDs which /bin/sh is sh)
  $(success rcdocker "$(green id)" --sh=sh)
  $(grey IDs which /bin/sh is dash)
  $(success rcdocker "$(green id)" --sh=dash)
  $(grey IDs which /bin/sh is bash)
  $(success rcdocker "$(green id)" --sh=bash)
  $(grey ID for image)
  $(success rcdocker "$(green id)" --image="alpine:latest" --base)

  $(grey Images for rc)
  $(success rcdocker "$(green image)")
  $(grey Image for base)
  $(success rcdocker "$(green image)" --base)
  $(grey Image for test)
  $(success rcdocker "$(green image)" --test)
  $(success rcdocker "$(green image)" --sh)
  $(grey Images which /bin/sh is sh)
  $(success rcdocker "$(green image)" --sh=sh)
  $(grey Images which /bin/sh is dash)
  $(success rcdocker "$(green image)" --sh=dash)
  $(grey Images which /bin/sh is bash)
  $(success rcdocker "$(green image)" --sh=bash)
  $(grey Image for rc and id)
  $(success rcdocker "$(green image)" --id="python3.10")
  $(grey Image for base and id)
  $(success rcdocker "$(green image)" --base --id="python3.10")
  $(grey Image for test and id)
  $(success rcdocker "$(green image)" --test --id="python3.10")

  $(grey Pull base images)
  $(success rcdocker "$(green pull)")
  $(grey Pull base ID image)
  $(success rcdocker "$(green pull)" --id="alpine")
  $(grey Pull base ID image)
  $(success rcdocker "$(green pull)" --id="alpine" --output)

  $(grey Run command for rc)
  $(success rcdocker "$(green run)" -- -c whoami)
  $(grey Run command --dry-run for rc and all IDs)
  $(success rcdocker "$(green run)" --dry-run -- -c ls)
  $(grey Run command with new test build for rc)
  $(success rcdocker "$(green run)" --test -- -c whoami)
  $(grey Run command and add image name to output for rc)
  $(success rcdocker "$(green run)" --show -- -c whoami)
  $(grey Run command with new test build and add image name to output for rc)
  $(success rcdocker "$(green run)" --show --test -- -c whoami)
  $(grey Run command for rc)
  $(success rcdocker "$(green run)" --id="alpine" -- -c whoami)
  $(grey Run command with new test build for rc)
  $(success rcdocker "$(green run)" --test --id="alpine" -- -c whoami)
  $(grey Run command and add image name to output  for rc)
  $(success rcdocker "$(green run)" --show --id="alpine" -- -c whoami)
  $(grey Run command with new test build  and add image name to output  for rc)
  $(success rcdocker "$(green run)" --show --test --id="alpine" -- -c whoami)
  $(grey Run command for base)
  $(success rcdocker "$(green run)" --base -- -c whoami)
  $(grey Run command and add image name to output for base)
  $(success rcdocker "$(green run)" --base --show -- -c whoami)
  $(grey Run command for base)
  $(success rcdocker "$(green run)" --base --id="alpine" -- -c whoami)
  $(grey Run command and add image name to output  for base)
  $(success rcdocker "$(green run)" --base --show --id="alpine" -- -c whoami)

  $(grey Variables)
  $(success rcdocker "$(green vars)")
  $(grey Variables for testing)
  $(success rcdocker "$(green vars)" --test)
  $(grey Variables for base)
  $(success rcdocker "$(green vars)" --base)
  $(grey Variables for repository)
  $(success rcdocker "$(green vars)" --repo="foo")
  $(grey Variables for repository and testing)
  $(success rcdocker "$(green vars)" --repo="foo" --test)

$(green Summary):
  $(success rcdocker "$(green build)")
  $(success rcdocker "$(green build)" --id="alpine")
  $(success rcdocker "$(green build)" --scan)
  $(success rcdocker "$(green build)" --push)
  $(success rcdocker "$(green build)" --test)
  $(success rcdocker "$(green create)" --base)
  $(success rcdocker "$(green create)" --base --start --force)
  $(success rcdocker "$(green create)" --base --force)
  $(success rcdocker "$(green create)")
  $(success rcdocker "$(green create)" --test --id="python3.10" --start --force)
  $(success rcdocker "$(green exec)" --id="bash" -- sh -c \"command -v wget\")
  $(success rcdocker "$(green exec)" --id="bash" -- sh --version)
  $(success rcdocker "$(green exec)" --id="bash" --entry -- sh --version)
  $(success rcdocker "$(green exec)" --id="bash" --entry='' -- sh --version)
  $(success rcdocker "$(green exec)" --id="hola" --entry='' -- bash --version)
  $(success rcdocker "$(green exec)" --entry='' -- bash --version)
  $(success rcdocker "$(green exec)" --id="bash" --entry='' -- bash --version)
  $(success rcdocker "$(green exec)" -- sh -c \"command -v wget\")
  $(success rcdocker "$(green exec)" --show -- sh -c \"command -v wget\")
  $(success rcdocker "$(green exec)" --base --show -- sh -c \"command -v wget\")
  $(success rcdocker "$(green exec)" --base --show --id="archlinux" -- sh -c \"command -v curl\")
  $(success rcdocker "$(green exec)" --base --show -- sh -c \"command -v curl\")
  $(success rcdocker "$(green exec)" --test --show -- sh -c \"command -v wget\")
  $(success rcdocker "$(green run)" --id="bash" -c whoami)
  $(success rcdocker "$(green run)" --id="bash" --entry="" -- bash --version)
  $(success rcdocker "$(green run)" -- -c whoami)
  $(success rcdocker "$(green run)" --show -- -c whoami)
  $(success rcdocker "$(green run)" --base --show -- -c whoami)
  $(success rcdocker "$(green run)" --test --show -- -c whoami)
"
  exit
}

#######################################
# Shows images and containers variables in fields
# Globals:
#   GIT               GitHub and Docker Hub repository owner.
#   IMAGES
#   FIELDS
#   REPOSITORY        [Internal]: repository name (default: rc).
#                     - Format: <repository name>
#                     - Examples: base, rc
#   TEST              Build prefix test images for rc (never get pushed).
# Locals:
#   enable            '1' if enabled, enable field of 'IMAGES'.
#   name              [Base]: image repository name, <repo name> field of 'IMAGES' (default: <repo owner>).
#                     - Format: <repo name>
#                     - Examples: alpine, systemd-ubuntu.
#   owner             [Base]: image repository owner, <repo owner> field of 'IMAGES'.
#                     - Format: <repo name>
#                     - Examples: alpine, systemd-ubuntu.
#   short             [Base]: image shortened tag.
#                     - Format: <tag> (-alpine removed)
#                     - Examples: 3.9
#   stripname         strip from <repo name>, stripname field of 'IMAGES'.
#   striptag          strip from <tag>, striptag field of 'IMAGES'.
#   sh        /bin/sh is bash.
# Outputs:
#   id                [Internal] tag (default: alpine)
#                     - Format: 1) <name>-<short>
#                               2) <name> (if tag is latest)
#                               3) <name><short> (for images with 'short' starting with numbers)
#                     - Examples: alpine, systemd-ubuntu, python3.9, bash5.1
#   build             [Internal]: image, default triggers auto build in Docker Hub (default: GIT/rc:alpine).
#                     - Format: <GIT>/<repository>:<id>
#                     - Examples: <GIT>/base:alpine, <GIT>/base:systemd-ubuntu, <GIT>/rc:python3.9
#   container         [Internal]: container name.
#                     - Format: <repository>@<id>
#                     - Examples: base@alpine, rc@systemd-ubuntu, base@python3.9, rc@bash5.1
#   repo              [Base]: image repository, similar to 'DOCKER_REPO' global, $1 of 'images' variable.
#                     - Format: index.docker.io/<repo owner>/<repo name>.
#                     - Examples: alpine, jrei/systemd-ubuntu.
#   tag               [Base]: image tag, similar to 'DOCKER_TAG', <tag> field of 'IMAGES'(default: latest).
#                     - Format: <tag>
#                     - Examples: latest, 3.9-alpine.
# Arguments:
#   repository        Repository or target.
#######################################
rcdocker::vars() {
  local param="${1:-${REPOSITORY:-}}"
  local enable owner name tag stripname striptag sh
  local id build container repo tag
  local line sep short suffix

  echo "${IMAGES}" | while read -r line; do
    [ "$(echo "${line}" | awk -F ';' '{ print NF-1 }')" -eq "$(( FIELDS-1 ))" ] \
      || die Incorrect Fields: "${line}"
  done

  while IFS=";" read -r enable owner name tag stripname striptag sh; do
    [ "${enable}" -ne "1" ] && continue
    sep="-"
    suffix=""
    : "${tag:=latest}"
    repo="${owner}${name:+/${name}}"
    short="${tag/${striptag}/}"
    [ "${short-}" ] && [ "${short:0:1}" -eq "${short:0:1}" ] 2>/dev/null && sep=""
    [ "${short}" = "latest" ] || suffix="${sep}${short}"
    name="${name/${stripname}/}"
    id="${name:-${owner}}${suffix}"
    if $BASE; then
      build="${repo}:${tag}"
      container="base.${id}"
    elif $TEST; then
      build="test.${param}:${id}"
      container="test.${param}.${id}"
    else
      build="${GIT}/${param}:${id}"
      container="${param}.${id}"
    fi
    echo "${id} ${build} ${container} ${repo} ${tag} ${sh}"
  done <<< "${IMAGES}"
}

#######################################
# Main function
# Globals:
#   BASE              Base images (never get pushed).
#   CACHE             build --no-cache
#   DOCKERFILE_PATH   Dockerfile currently being built.
#   DEFAULT_TARGET    When targets are active.
#   ENTRY             Overwrite ENTRYPOINT.
#   FORCE             Forces creation of container, default true for --test.
#   GIT               Docker Hub User.
#   HUB               Running in auto build Docker Hub.
#   ID                The ID to build, create, exec or run command (default: all).
#   IMAGE             IMAGE to get ID (default: all).
#   FUNC              Functions prefix.
#   OUTPUT            show output in plain format even if succesful build.
#   PUSH              Perform push after build.
#   REPOSITORY        rc.
#   SCAN              Perform scan.
#   SHOW              Show image id for exec and run.
#   START             To start container after creation.
#   TARGET            --target option.
#   TARGETS           Targets from Dockerfile.
#   TEST              Build prefix test images for rc (never get pushed).
#   WARN              Show warnings.
#######################################
# shellcheck disable=SC2086
rcdocker::main() {
  local arg args=() command dry=false finish=false ids msg="Option" targets
  export BASE=false CACHE DOCKERFILE_PATH ENTRY="/bin/sh" FORCE=false GIT=j5pu HUB=true ID IMAGE
  export FUNC="${FUNCNAME[0]%%:*}" OUTPUT=false PUSH=false REPOSITORY="rc" SCAN=false SH SHOW=false
  export START=false TARGET TARGETS TEST=false WARN=false
  if [ ! "${DOCKERFILE_PATH-}" ]; then
    cd "$(dirname "${0}")/.." || exit 1
    DOCKERFILE_PATH="./Dockerfile"
    HUB=false
  fi
  TARGETS="$(awk '! /^#/ && / AS / || / as / { print $4 }' "${DOCKERFILE_PATH}")"

  ! $HUB || rcdocker::build

  ids="$(rcdocker::id)"

  [ "${1-}" ] || rcdocker::usage

  for arg; do
    if $finish; then
      args+=("${arg}")
      continue
    fi
    case "${arg}" in
      --base) BASE=true ;;
      --dry-run) dry=true ;;
      --entry=*) ENTRY="${arg/--entry=/}" ;;
      --force) FORCE=true ;;
      --image=*) IMAGE="${arg/--image=/}" ;;
      --id=*)
        ID="${arg/--id=/}"
        echo "${ids}" | grep -q "${ID}" || die Invalid ID: "${ID}"
        ;;
      --no-cache) CACHE="${arg}" ;;
      --output) OUTPUT=true ;;
      --push) PUSH=true ;;
      --repo=*) REPOSITORY="${arg/--repo=/}" ;;
      --scan) SCAN=true ;;
      --sh|--sh=) SH='sh' ;;
      --sh=*) SH="${arg/--sh=/}" ;;
      --show) SHOW=true ;;
      --start) START=true ;;
      --target=*)
        TARGET="${arg/--target=/}"
        [ "${TARGET-}" ] || die Empty Target
        [ "${TARGETS-}" ] || die Target Provided and no targets in Dockerfile: "${TARGET}"
        echo "${TARGETS}" | grep -q "${TARGET}" || die Invalid Target: "${TARGET}"
        ;;
      --test) CACHE="--no-cache"; FORCE=true; TEST=true; ;;
      --warn) WARN=true ;;
      --) finish=true ;;
      build|clean|create|exec|id|image|pull|run|vars)
        if ! $finish; then
          [ ! "${command-}" ] || die One Command Allowed: "${arg}" and "${1}"
          command="${arg}"
          [ "${command}" != "pull" ] || BASE=true
        fi
        ;;
      *)
        [ "${arg:0:1}" = "-" ] || msg="command"
        false || die Invalid "${msg}": "${arg}"
        ;;
    esac
  done

  if [[ "${command}" =~ ^exec$|^run$ ]]; then
    if ! $finish; then
      false || die Arguments passed to "${command}" must be separated with: --, i.e.: build run -- ls
    else
      [ "${args-}" ] || die No Arguments: "${command}"
    fi
  fi

  if $BASE; then
    unset REPOSITORY TARGET
    SCAN=false
    TEST=false
    PUSH=false
    [ "${command}" != "build" ] || command="pull"
  fi

  ! $TEST || PUSH=false

  if [ "${command-}" ]; then
    if $dry; then
      debug BASE CACHE DOCKERFILE_PATH EXCLUDE FORCE HUB ID OUTPUT PUSH REPOSITORY SH SHOW TARGET targets
      die "${command}" "${args[@]}"
    fi
    if [ "${args-}" ]; then
      rcdocker::${command} "${args[@]}"
    else
      rcdocker::${command}
    fi
  fi
}

#######################################
# description
# Arguments:
#   1
#######################################
cat(){ echo; command cat "${1}"; }

rcdocker::main "$@"
