#!/bin/sh

# Automatic creation of system and PATH variables compat directory for rc.d
#
set -eu


# shellcheck disable=SC1090
path() { "$(command -p dirname "$0")/colon" > "${file}"; . "${file}"; }

proxy() {
  set -x
  for func in system path; do
    file="${RC_GENERATED}/${func}.sh"
    aliases="${RC_GENERATED_ALIASES}/${func}.sh"
    tmp="$(command -p mktemp)"
    if [ ! -f "${file}" ] || $FORCE; then
      command -p rm -f "${file}"
      command -p rm -f "${aliases}"
      ${func}
      sort "${file}"
      sort "${aliases}"
    fi
  done

  # shellcheck disable=SC2016
  command -p env | command -p awk -F '=' '/^RC_[A-Z].*=/ {print $1}' | while read -r variable; do
    value="$(eval echo "\$${variable}")"
    [ ! -d "${value}" ] || write_alias "${variable}" "${value}"
  done
}

sort() {
  tmp="$(mktemp)"
  if [ -f "${1}" ]; then
    command -p sort "${1}" > "${tmp}"
    command -p mv "${tmp}" "${1}"
  fi
}

write() {
  echo "export $(echo "${1}" | command -p tr '[:lower:]' '[:upper:]')='${2}'" >> "${file}"
  # shellcheck disable=SC1090
  . "${file}"
  case "${1}" in
    PM_INSTALL) write_alias "${1}" "${2}" ;;
  esac
  [ ! -d "${2}" ] || write_alias "${1}" "${2}"
}

write_alias() { echo "alias .$(echo "${1}" | command -p tr '[:upper:]' '[:lower:]')='${2}'" >> "${aliases}"; }

main() {
  FORCE=false; [ "${RC_PROFILE-0}" -eq 1 ] || FORCE=true
  if [ "$#" -eq 0 ]; then
    proxy
  elif [ "${1-}" = '--force' ]; then
    FORCE=true
    proxy
  elif [ "${1-}" != '--parsed' ]; then
    PARSE="${0}" parse "$@"
  fi
}

main "$@"
